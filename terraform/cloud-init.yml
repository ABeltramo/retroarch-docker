package_update: true
repo_upgrade: all
packages:
  - docker.io
groups:
  - docker
users:
  - default
  - name: ubuntu
    groups: docker
runcmd:
  # Update docker-compose
  - curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  # Nvidia drivers
  - apt-get install -y --no-install-recommends nvidia-driver-460
  # NVIDIA Container Toolkit
  - curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
  - curl -s -L https://nvidia.github.io/nvidia-docker/$(. /etc/os-release;echo $ID$VERSION_ID)/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
  - apt-get update -y
  - apt-get install -y --no-install-recommends nvidia-docker2
  - systemctl restart docker
  # Fix permissions
  - mkdir /tmp/gow/images
  - mkdir /tmp/gow/local_state
  - chown -R ubuntu:ubuntu /tmp/gow
  # Start docker-compose
  - cd /tmp/gow && docker-compose pull
  - cd /tmp/gow && docker-compose up -d